@{
    ViewData["Title"] = "Tạo phiếu yêu cầu nhập hàng";
    Layout = "~/Areas/Warehouse/Views/Shared/_Layout.cshtml";

    var ListProduct = ViewBag.ListProduct as IList<Entities.Models.ProductDetail>;
}

<div class="container-fluid">
    @if (!(ViewBag.MessageSuccess is null))
    {
        <div class="alert alert-success">@ViewBag.Message</div>
    }
    <h1 class="h3 mb-2 text-gray-800">Tạo phiếu yêu cầu nhập hàng</h1>
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <form asp-action="AutoCreateReceiptRequest" asp-controller="Recommandation" asp-area="Warehouse" method="post" id="form">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Mã sản phẩm</th>
                                <th>Tên sản phẩm</th>
                                <th>Màu sắc</th>
                                <th>Số lượng trong kho</th>
                                <th>Số lượng còn lại</th>
                                <th>Số lượng cần đặt</th>
                                <th>Chọn</th>

                            </tr>
                        </thead>
                        <tbody>
                            @if (ListProduct is not null)
                            {
                                @foreach (var item in ListProduct)
                                {
                                    <tr>
                                        <td>@item.ProductDetailId</td>
                                        <td>@item.Product.ProductName</td>
                                        <td>@item.Color</td>
                                        <td>@item.Quantity</td>

                                        <td>@item.RemainingQuantity</td>
                                        <td><input type="number" min="0" onkeypress='return event.charCode > 46 && event.charCode < 58' name="quantity" /></td>
                                        <td><input type="checkbox" name="selected" value="@item.ProductDetailId" /></td>
                                    </tr>
                                }
                            }
                            

                        </tbody>
                    </table>
                </form>
                    <input type="button" value="Tạo phiếu" class="btn btn-success" onclick="submit()" />

            </div>
        </div>
    </div>
</div>
@section Scripts
{
    <script>
        $(document).ready(function () {
            $('#best-seller').DataTable();
            $('#buy-together').DataTable();
        });

        function submit() {
            var countErrorValidate = 0;
            var Quantities = document.getElementsByName('quantity');
            var Selected = document.getElementsByName('selected');
            var count = Selected.length;
            $('.field-validation-valid').remove();
            for (var i = 0; i < Quantities.length; i++) {
                if ((Quantities[i].value === '' || Quantities[i] === 0) && Selected[i].checked) {
                    var node = Quantities[i];
                    var text = '<span class="field-validation-valid text-danger validate-product-detail">' +
                        'Số lượng không hợp lệ</span>';
                    countErrorValidate++;
                    $(node).parent().append(text);
                }
                if ((Quantities[i].value !== '' || Quantities[i] !== 0) && Selected[i].checked) {
                    count--;
                }

            }

            if (countErrorValidate > 0 || Quantities.length === count) {
                if (Quantities.length === count) {
                    Swal.fire({
                        title: 'Thông báo',
                        text: "Không có sản phẩm nào được chọn! ",
                        icon: 'info',
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: `Ok`,
                    });
                } else {
                    Swal.fire({
                        title: 'Thông báo',
                        text: "Số lượng không được để trống! ",
                        icon: 'info',
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: `Ok`,
                    });
                }

            } else {
                $('#form').submit();
            }
        }



        function ShowBestSeller() {

            var quantity = $('#quantity').val();
            var fromDate = $('#fromdate').val();
            var toDate = $('#todate').val();
            var listProduct = [];
            $.ajax({
                url: '/Warehouse/Recommandation/GetBestSeller',
                method: 'GET',
                async: true,
                data: { fromDate: fromDate, toDate: toDate, quantity: quantity },
                success: function (data) {
                    listProduct = JSON.parse(data);
                    var str = '';
                    for (let item of listProduct) {
                        str += '<tr><td>' + item.productDetailId + '</td>' +
                            '<td>' + item.productName + '</td>' +
                            '<td>' + item.color + '</td>' +
                            '<td>' + item.totalQuantity + '</td>' +
                            '<td>' + item.quantityOrdered + '</td>' +
                            '<td>' + item.RemainingQuantity + '</td></tr>';
                    }
                    $('#BestSeller').html(str);
                    if (listProduct.length > 0) {
                        $.ajax({
                            url: '/Warehouse/Recommandation/GetRecommandation',
                            method: 'GET',
                            async: true,
                            success: function (data) {
                                var listProduct = JSON.parse(data);
                                var str = '';
                                for (let item of listProduct) {
                                    str += '<tr><td>' + item.productDetailId + '</td>' +
                                        '<td>' + item.productName + '</td>' +
                                        '<td>' + item.color + '</td>' +
                                        '<td>' + item.totalQuantity + '</td>' +
                                        '<td>' + item.quantityOrdered + '</td>' +
                                        '<td>' + item.RemainingQuantity + '</td></tr>';
                                }
                                $('#Rule').html(str);
                            }
                        })
                    }
                }
            });
        }
    </script>
}
